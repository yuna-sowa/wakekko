<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ã‚ã‘ã£ã“ - å‰²ã‚Šå‹˜ã‚¢ãƒ—ãƒª</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700;900&display=swap" rel="stylesheet">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#F4A987">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Zen Maru Gothic', 'Hiragino Kaku Gothic ProN', sans-serif;
      background: #FFF5F5;
      color: #333333;
      min-height: 100vh;
      line-height: 1.75;
    }

    /* ========== ãƒ˜ãƒƒãƒ€ãƒ¼ / ãƒ­ã‚´ ========== */
    .header {
      background: #fff;
      text-align: center;
      padding: 40px 16px 36px;
      border-bottom: 2px solid #FFE0E0;
    }
    .logo {
      font-size: 30px;
      font-weight: 900;
      color: #E8707A;
      letter-spacing: 8px;
    }
    .logo-sub {
      font-size: 12px;
      font-weight: 500;
      color: #999;
      margin-top: 6px;
      letter-spacing: 2px;
    }

    /* ========== 2ã‚«ãƒ©ãƒ  ========== */
    .layout {
      display: flex;
      gap: 32px;
      max-width: 1040px;
      margin: 0 auto;
      padding: 36px 32px;
      align-items: flex-start;
    }
    .col-left  { flex: 1; min-width: 0; }
    .col-right { flex: 1; min-width: 0; position: sticky; top: 36px; }

    /* ========== ã‚«ãƒ¼ãƒ‰å…±é€š ========== */
    .card {
      background: #fff;
      border-radius: 20px;
      padding: 28px;
      box-shadow: 0 2px 10px rgba(200,100,100,0.06);
      margin-bottom: 28px;
    }
    .card-title {
      font-size: 12px;
      font-weight: 700;
      color: #E8707A;
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 1px solid #FFE8E8;
      letter-spacing: 2px;
      text-transform: uppercase;
    }

    /* ========== ãƒ•ã‚©ãƒ¼ãƒ  ========== */
    .form-grid {
      display: flex;
      gap: 10px;
      margin-bottom: 16px;
    }
    .form-grid input[type="text"] {
      flex: 1;
      min-width: 0;
    }
    .form-grid input[type="number"] {
      width: 100px;
      flex-shrink: 0;
    }
    .form-grid input {
      padding: 13px 18px;
      border: 1.5px solid #F0D8D8;
      border-radius: 16px;
      font-size: 14px;
      font-family: inherit;
      color: #333333;
      background: #fff;
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .form-grid input:focus {
      border-color: #E8707A;
      box-shadow: 0 0 0 3px rgba(232,112,122,0.10);
    }
    .form-grid input::placeholder { color: #ccc; }

    .btn-add {
      width: 100%;
      padding: 14px;
      background: #E8707A;
      color: #fff;
      border: none;
      border-radius: 16px;
      font-size: 14px;
      font-weight: 700;
      font-family: inherit;
      cursor: pointer;
      letter-spacing: 2px;
      transition: background 0.2s, transform 0.15s;
      box-shadow: 0 3px 10px rgba(232,112,122,0.25);
    }
    .btn-add:hover { background: #D8606A; }
    .btn-add:active { transform: scale(0.98); }

    /* ========== å•†å“ã‚«ãƒ¼ãƒ‰ ========== */
    .item-card {
      background: #fff;
      border-radius: 18px;
      padding: 20px 22px;
      box-shadow: 0 2px 10px rgba(200,100,100,0.06);
      margin-bottom: 14px;
      animation: fadeUp 0.25s ease;
    }
    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(-6px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    .item-top {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 12px;
    }
    .item-top > div { min-width: 0; flex: 1; }
    .item-name {
      font-size: 14px;
      font-weight: 700;
      color: #333333;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
      word-break: break-all;
    }
    .item-price-badge {
      display: inline-block;
      font-size: 13px;
      font-weight: 700;
      color: #E8707A;
      background: #FFF0F0;
      padding: 4px 14px;
      border-radius: 10px;
      margin-top: 6px;
    }
    .btn-del {
      background: #FFF5F5;
      border: 1px solid #F0D8D8;
      color: #D0A8A8;
      width: 30px;
      height: 30px;
      border-radius: 10px;
      font-size: 15px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      flex-shrink: 0;
    }
    .btn-del:hover {
      background: #FFE0E0;
      border-color: #E09090;
      color: #C05050;
    }

    /* ========== ãƒ¡ãƒ³ãƒãƒ¼é¸æŠãƒ”ãƒ« ========== */
    .checks {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .pill input { display: none; }
    .pill label {
      display: inline-block;
      padding: 6px 18px;
      border: 1.5px solid #F0D8D8;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
      color: #bbb;
      cursor: pointer;
      transition: all 0.2s;
      user-select: none;
    }
    /* è‡ªåˆ†: ãƒ”ãƒ³ã‚¯ */
    .pill input:checked + label.cl-me {
      border-color: #F0A0A8;
      background: #FFF0F0;
      color: #C85060;
      font-weight: 700;
    }
    /* Aã•ã‚“: ãƒŸãƒ³ãƒˆ */
    .pill input:checked + label.cl-a {
      border-color: #90C8B8;
      background: #F0FAF6;
      color: #408070;
      font-weight: 700;
    }
    /* Bã•ã‚“: ãƒ©ãƒ™ãƒ³ãƒ€ãƒ¼ */
    .pill input:checked + label.cl-b {
      border-color: #C0B0D8;
      background: #F5F0FA;
      color: #685088;
      font-weight: 700;
    }
    /* Cã•ã‚“: ã‚¢ãƒ—ãƒªã‚³ãƒƒãƒˆ */
    .pill input:checked + label.cl-c {
      border-color: #E8C098;
      background: #FFF8F0;
      color: #A87030;
      font-weight: 700;
    }

    .split-note {
      font-size: 11px;
      color: #bbb;
      margin-top: 10px;
    }
    .split-note b { color: #E8707A; }

    .empty-msg {
      text-align: center;
      color: #ccc;
      padding: 48px 16px;
      font-size: 13px;
    }

    /* ========== çµæœ: åˆè¨ˆã‚«ãƒ¼ãƒ‰ ========== */
    .totals-grid {
      display: flex;
      gap: 10px;
      margin-bottom: 24px;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      padding-bottom: 4px;
    }
    .totals-grid::-webkit-scrollbar { display: none; }
    .total-box {
      flex: 1 0 auto;
      min-width: 80px;
      text-align: center;
      padding: 20px 14px;
      border-radius: 18px;
    }
    .total-box.me { background: #FFF0F0; }
    .total-box.a  { background: #F0FAF6; }
    .total-box.b  { background: #F5F0FA; }
    .total-box.c  { background: #FFF8F0; }

    .total-name {
      font-size: 11px;
      font-weight: 700;
      margin-bottom: 6px;
      letter-spacing: 1px;
    }
    .total-box.me .total-name { color: #C85060; }
    .total-box.a  .total-name { color: #408070; }
    .total-box.b  .total-name { color: #685088; }
    .total-box.c  .total-name { color: #A87030; }

    .total-yen {
      font-size: 26px;
      font-weight: 900;
      letter-spacing: -0.5px;
      white-space: nowrap;
      color: #333333;
    }

    /* ========== å†…è¨³ãƒ†ãƒ¼ãƒ–ãƒ« ========== */
    .detail-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      font-size: 13px;
    }
    .detail-table thead th {
      padding: 12px 6px;
      font-size: 11px;
      font-weight: 700;
      color: #bbb;
      text-align: center;
      border-bottom: 1px solid #FFE8E8;
    }
    .detail-table thead th:first-child { text-align: left; }
    .detail-table thead .h-me { color: #C85060; }
    .detail-table thead .h-a  { color: #408070; }
    .detail-table thead .h-b  { color: #685088; }
    .detail-table thead .h-c  { color: #A87030; }

    .detail-table tbody td {
      padding: 11px 6px;
      text-align: center;
      border-bottom: 1px solid #FFF0F0;
    }
    .detail-table tbody tr:last-child td { border-bottom: none; }
    .detail-table tbody td:first-child {
      text-align: left;
      font-weight: 500;
      color: #666666;
      font-size: 12px;
      max-width: 100px;
      word-break: break-all;
    }
    .detail-table tbody td:first-child .cell-name {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .detail-table tbody tr.expanded td:first-child .cell-name {
      -webkit-line-clamp: unset;
      overflow: visible;
    }
    .detail-table tbody tr { cursor: pointer; transition: background 0.15s; }
    .detail-table tbody tr:active { background: #FFF5F5; }
    .detail-table .val  { color: #333333; font-weight: 700; font-size: 14px; }
    .detail-table .zero { color: #ddd; }

    .detail-table tfoot td {
      padding: 14px 6px;
      font-weight: 900;
      font-size: 15px;
      text-align: center;
      border-top: 1px solid #FFE8E8;
      color: #333333;
    }
    .detail-table tfoot td:first-child { text-align: left; color: #666666; }

    .result-empty {
      text-align: center;
      color: #ccc;
      padding: 40px 0;
      font-size: 13px;
    }

    /* ========== ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ ========== */
    .btn-clear {
      width: 100%;
      padding: 13px;
      background: #fff;
      color: #bbb;
      border: 1.5px solid #F0D8D8;
      border-radius: 16px;
      font-size: 12px;
      font-weight: 700;
      font-family: inherit;
      cursor: pointer;
      letter-spacing: 1px;
      transition: all 0.2s;
    }
    .btn-clear:hover {
      background: #FFF5F5;
      border-color: #E8B0B0;
      color: #999;
    }

    /* ========== ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– ========== */
    @media (max-width: 720px) {
      .layout {
        flex-direction: column;
        padding: 24px 18px;
        gap: 24px;
      }
      .col-right { position: static; }
      .total-box { min-width: 72px; padding: 18px 10px; }
      .total-yen { font-size: 22px; }
      .form-grid { gap: 8px; }
      .header { padding: 32px 16px 28px; }
      .logo { font-size: 26px; letter-spacing: 6px; }
    }
    @media (max-width: 400px) {
      .logo { font-size: 22px; letter-spacing: 4px; }
      .logo-sub { font-size: 11px; }
      .totals-grid { gap: 8px; }
      .total-box { min-width: 68px; padding: 16px 8px; }
      .total-yen { font-size: 20px; }
      .form-grid { flex-wrap: wrap; }
      .form-grid input[type="text"] { flex: 1 1 100%; }
      .form-grid input[type="number"] { flex: 1 1 100%; width: auto; }
      .detail-table { font-size: 12px; }
      .detail-table .val { font-size: 13px; }
    }

    /* ========== ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ ========== */
    #screen-start {
      min-height: 100vh;
      background: #FAF8F4;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 48px 32px 64px;
    }
    #screen-main { display: none; }

    .start-illustration {
      font-size: 64px;
      margin-bottom: 8px;
      line-height: 1;
    }
    .start-logo {
      font-size: 48px;
      font-weight: 900;
      color: #C9673A;
      letter-spacing: 10px;
      margin-bottom: 16px;
    }
    .start-tagline {
      font-size: 14px;
      font-weight: 500;
      color: #A89080;
      letter-spacing: 1.5px;
      text-align: center;
      line-height: 1.9;
      margin-bottom: 64px;
    }
    .btn-start {
      width: 100%;
      max-width: 320px;
      padding: 20px 24px;
      background: #C9673A;
      color: #fff;
      border: none;
      border-radius: 24px;
      font-size: 16px;
      font-weight: 700;
      font-family: inherit;
      letter-spacing: 2px;
      cursor: pointer;
      box-shadow: 0 6px 20px rgba(201,103,58,0.30);
      transition: background 0.2s, transform 0.15s, box-shadow 0.2s;
    }
    .btn-start:hover {
      background: #B8592E;
      box-shadow: 0 8px 24px rgba(201,103,58,0.38);
    }
    .btn-start:active {
      transform: scale(0.97);
      box-shadow: 0 3px 12px rgba(201,103,58,0.25);
    }
    .start-footer {
      margin-top: 40px;
      font-size: 11px;
      color: #C8B8B0;
      letter-spacing: 1px;
    }

    /* ========== ãƒ¬ã‚·ãƒ¼ãƒˆèª­ã¿è¾¼ã¿ç”»é¢ ========== */
    #screen-upload {
      min-height: 100vh;
      background: #FAF8F4;
      display: none;
      flex-direction: column;
    }
    .upload-header {
      display: flex;
      align-items: center;
      padding: 20px 20px 0;
      position: relative;
      min-height: 52px;
    }
    .btn-back {
      background: none;
      border: none;
      font-family: inherit;
      font-size: 13px;
      font-weight: 700;
      color: #B09888;
      cursor: pointer;
      padding: 8px 4px;
      letter-spacing: 0.5px;
      z-index: 1;
    }
    .btn-back:active { opacity: 0.6; }
    .upload-page-title {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      font-size: 13px;
      font-weight: 700;
      color: #7A5C48;
      letter-spacing: 2.5px;
      white-space: nowrap;
    }
    .upload-body {
      flex: 1;
      padding: 28px 24px 56px;
      display: flex;
      flex-direction: column;
      gap: 18px;
      max-width: 480px;
      margin: 0 auto;
      width: 100%;
    }
    /* é¸æŠå‰: ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚¾ãƒ¼ãƒ³ */
    .upload-zone {
      display: block;
      width: 100%;
      aspect-ratio: 3 / 4;
      max-height: 52vh;
      border: 2px dashed #D4C4B8;
      border-radius: 24px;
      background: #FFFAF7;
      cursor: pointer;
      overflow: hidden;
      position: relative;
      transition: border-color 0.2s, background 0.2s;
    }
    .upload-zone:hover       { border-color: #C9673A; background: #FFF6EF; }
    .upload-zone.has-image   { border-style: solid; border-color: #C9673A; }
    .upload-zone-placeholder {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 12px;
      transition: opacity 0.2s;
    }
    .upload-zone.has-image .upload-zone-placeholder { opacity: 0; pointer-events: none; }
    .upload-zone-icon  { font-size: 52px; line-height: 1; }
    .upload-zone-label {
      font-size: 14px;
      font-weight: 700;
      color: #B09888;
      letter-spacing: 1.5px;
    }
    .upload-zone-sub {
      font-size: 11px;
      color: #C8B8B0;
      letter-spacing: 0.8px;
    }
    /* ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒ */
    .preview-img {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: none;
    }
    .upload-zone.has-image .preview-img { display: block; }
    /* é¸æŠæ¸ˆã¿ãƒãƒƒã‚¸ */
    .preview-badge {
      position: absolute;
      bottom: 14px;
      right: 14px;
      background: rgba(201,103,58,0.88);
      color: #fff;
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 1px;
      padding: 6px 14px;
      border-radius: 20px;
      display: none;
    }
    .upload-zone.has-image .preview-badge { display: block; }
    /* ãƒ©ã‚¤ãƒ–ãƒ©ãƒª / ã‚«ãƒ¡ãƒ© ãƒœã‚¿ãƒ³è¡Œ */
    .upload-btn-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .btn-upload-opt {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      padding: 18px 12px;
      background: #fff;
      border: 1.5px solid #E8D8CC;
      border-radius: 20px;
      font-family: inherit;
      font-size: 12px;
      font-weight: 700;
      color: #8A6858;
      letter-spacing: 1px;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 2px 8px rgba(180,130,100,0.06);
    }
    .btn-upload-opt:hover  { background: #FFF5EE; border-color: #C9673A; color: #C9673A; }
    .btn-upload-opt:active { transform: scale(0.97); }
    .btn-upload-opt-icon   { font-size: 26px; line-height: 1; }
    /* è§£æãƒœã‚¿ãƒ³ */
    .btn-analyze {
      width: 100%;
      padding: 20px 24px;
      background: #C9673A;
      color: #fff;
      border: none;
      border-radius: 24px;
      font-size: 16px;
      font-weight: 700;
      font-family: inherit;
      letter-spacing: 2px;
      cursor: pointer;
      box-shadow: 0 6px 20px rgba(201,103,58,0.30);
      transition: background 0.2s, transform 0.15s, box-shadow 0.2s, opacity 0.2s;
      margin-top: 4px;
    }
    .btn-analyze:disabled {
      background: #D4C4B8;
      box-shadow: none;
      cursor: not-allowed;
      opacity: 0.65;
    }
    .btn-analyze:not(:disabled):hover  { background: #B8592E; box-shadow: 0 8px 24px rgba(201,103,58,0.38); }
    .btn-analyze:not(:disabled):active { transform: scale(0.97); box-shadow: 0 3px 12px rgba(201,103,58,0.22); }
    .upload-note {
      text-align: center;
      font-size: 11px;
      color: #C8B8B0;
      letter-spacing: 0.5px;
      line-height: 1.8;
    }

    /* ========== OCRè§£æçµæœ ========== */
    .ocr-result-box {
      background: #FFFAF7;
      border: 1.5px solid #E8D8CC;
      border-radius: 20px;
      padding: 20px;
    }
    .ocr-result-title {
      font-size: 12px;
      font-weight: 700;
      color: #C9673A;
      margin-bottom: 12px;
      letter-spacing: 2px;
      text-transform: uppercase;
    }
    .ocr-text-area {
      font-size: 12px;
      color: #6A5848;
      line-height: 1.9;
      white-space: pre-wrap;
      word-break: break-all;
      max-height: 200px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
    }
    .ocr-parsed-list {
      margin-top: 14px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .ocr-parsed-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #FFF5EE;
      border-radius: 12px;
      padding: 8px 14px;
      font-size: 13px;
      font-weight: 500;
      color: #7A5C48;
    }
    .ocr-parsed-item span:last-child {
      font-weight: 700;
      color: #C9673A;
    }
    .ocr-empty {
      text-align: center;
      color: #C8B8B0;
      font-size: 12px;
      padding: 12px 0;
      letter-spacing: 0.5px;
    }
  </style>
</head>
<body>

<!-- ========== ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ ========== -->
<div id="screen-start">
  <div class="start-illustration">ğŸ§¾</div>
  <div class="start-logo">ã‚ã‘ã£ã“</div>
  <div class="start-tagline">ãƒ¬ã‚·ãƒ¼ãƒˆã‚’èª­ã¿è¾¼ã‚“ã§<br>ã‹ã‚“ãŸã‚“å‰²ã‚Šå‹˜</div>
  <button class="btn-start" id="btnGoUpload">ãƒ¬ã‚·ãƒ¼ãƒˆã‚’èª­ã¿è¾¼ã‚€</button>
  <input type="file" id="startCameraInput" accept="image/*" capture="environment" style="display:none">
  <div class="start-footer">ã¾ãšã¯ãƒ¬ã‚·ãƒ¼ãƒˆã®å†™çœŸã‚’ç”¨æ„ã—ã¦ã­</div>
</div>

<!-- ========== ãƒ¬ã‚·ãƒ¼ãƒˆèª­ã¿è¾¼ã¿ç”»é¢ ========== -->
<div id="screen-upload">
  <div class="upload-header">
    <button class="btn-back" id="btnBack">â† ã‚‚ã©ã‚‹</button>
    <div class="upload-page-title">ãƒ¬ã‚·ãƒ¼ãƒˆã‚’èª­ã¿è¾¼ã‚€</div>
  </div>

  <div class="upload-body">
    <!-- ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¾ãƒ¼ãƒ³ï¼ˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªç”¨ï¼‰ -->
    <label class="upload-zone" id="uploadZone" for="fileInput">
      <div class="upload-zone-placeholder">
        <div class="upload-zone-icon">ğŸ§¾</div>
        <div class="upload-zone-label">ã‚¿ãƒƒãƒ—ã—ã¦ç”»åƒã‚’é¸æŠ</div>
        <div class="upload-zone-sub">JPG Â· PNG Â· HEIC ã«å¯¾å¿œ</div>
      </div>
      <img class="preview-img" id="previewImg" alt="ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼">
      <div class="preview-badge">âœ“ é¸æŠæ¸ˆã¿</div>
    </label>
    <input type="file" id="fileInput" accept="image/*" style="display:none">
    <!-- ã‚«ãƒ¡ãƒ©å°‚ç”¨ inputï¼ˆcaptureï¼‰ -->
    <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display:none">

    <!-- ã‚µãƒ–ãƒœã‚¿ãƒ³è¡Œ -->
    <div class="upload-btn-row">
      <button class="btn-upload-opt" id="btnLibrary">
        <span class="btn-upload-opt-icon">ğŸ–¼ï¸</span>
        <span>ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‹ã‚‰</span>
      </button>
      <button class="btn-upload-opt" id="btnCamera">
        <span class="btn-upload-opt-icon">ğŸ“·</span>
        <span>å†™çœŸã‚’æ’®ã‚‹</span>
      </button>
    </div>

    <!-- è§£æãƒœã‚¿ãƒ³ -->
    <button class="btn-analyze" id="btnAnalyze" disabled>è§£æã™ã‚‹</button>
    <p class="upload-note">ãƒ¬ã‚·ãƒ¼ãƒˆå…¨ä½“ãŒæ˜ ã‚‹ã‚ˆã†ã«æ’®å½±ã—ã¦ãã ã•ã„</p>

    <!-- OCRè§£æçµæœã‚¨ãƒªã‚¢ -->
    <div id="ocrResult" style="display:none">
      <div class="ocr-result-box">
        <div class="ocr-result-title">è§£æçµæœ</div>
        <div id="ocrText" class="ocr-text-area"></div>
        <div id="ocrParsedList" class="ocr-parsed-list"></div>
      </div>
      <button class="btn-analyze" id="btnGoMain" style="display:none;margin-top:4px">å‰²ã‚Šå‹˜ãƒªã‚¹ãƒˆã«è¿½åŠ ã—ã¦é€²ã‚€ â†’</button>
    </div>
  </div>
</div>

<!-- ========== ãƒ¡ã‚¤ãƒ³ç”»é¢ ========== -->
<div id="screen-main">
<div class="header">
  <div class="logo">ã‚ã‘ã£ã“</div>
  <div class="logo-sub">ã¿ã‚“ãªã§ã‹ã‚“ãŸã‚“å‰²ã‚Šå‹˜</div>
</div>

<div class="layout">
  <!-- ===== å·¦ã‚«ãƒ©ãƒ : å…¥åŠ› ===== -->
  <div class="col-left">
    <div class="card">
      <div class="card-title">å•†å“ã‚’è¿½åŠ </div>
      <div class="form-grid">
        <input type="text" id="itemName" placeholder="å•†å“åï¼ˆä¾‹: ãƒ”ã‚¶ï¼‰">
        <input type="number" id="itemPrice" placeholder="Â¥ é‡‘é¡" min="0">
      </div>
      <button class="btn-add" id="btnAdd">+ è¿½åŠ ã™ã‚‹</button>
    </div>

    <div id="itemList">
      <div class="empty-msg">å•†å“ã‚’è¿½åŠ ã™ã‚‹ã¨ã€ã“ã“ã«ä¸€è¦§ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div>
    </div>

    <button class="btn-clear" id="btnClear">ã™ã¹ã¦ã‚¯ãƒªã‚¢</button>
  </div>

  <!-- ===== å³ã‚«ãƒ©ãƒ : çµæœ ===== -->
  <div class="col-right">
    <div class="card" id="resultCard">
      <div class="card-title">è¨ˆç®—çµæœ</div>
      <div id="resultContent">
        <div class="result-empty">å•†å“ã‚’è¿½åŠ ã™ã‚‹ã¨ã“ã“ã«çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div>
      </div>
    </div>
  </div>
</div>

<script>
  /* ================================================================
     ã‚ã‘ã£ã“ â€” ãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯
     ----------------------------------------------------------------
     OCR ã‚¨ãƒ³ã‚¸ãƒ³: Google Cloud Vision API (TEXT_DETECTION)
     APIã‚­ãƒ¼ã®æ¸¡ã—æ–¹: URL ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ ?APIkey=YOUR_KEY
       ä¾‹) https://yuna-sowa.github.io/wakekko/?APIkey=AIzaSy...
           http://localhost:8080/?APIkey=AIzaSy...
     ================================================================ */

  // â”€â”€ å®šæ•°ãƒ»çŠ¶æ…‹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const MEMBERS = [
    { key: 'me', label: 'è‡ªåˆ†',  cl: 'cl-me', box: 'me', hcl: 'h-me', fcl: 'f-me' },
    { key: 'a',  label: 'Aã•ã‚“', cl: 'cl-a',  box: 'a',  hcl: 'h-a',  fcl: 'f-a'  },
    { key: 'b',  label: 'Bã•ã‚“', cl: 'cl-b',  box: 'b',  hcl: 'h-b',  fcl: 'f-b'  },
    { key: 'c',  label: 'Cã•ã‚“', cl: 'cl-c',  box: 'c',  hcl: 'h-c',  fcl: 'f-c'  },
  ];

  const items = [];
  const $ = id => document.getElementById(id);
  let selectedFile = null;
  let currentParsedResult = null; // OCRè§£æçµæœã‚’ä¿æŒã™ã‚‹ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°

  // â”€â”€ ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  // XSS å¯¾ç­–: ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã‚„å¤–éƒ¨ãƒ†ã‚­ã‚¹ãƒˆã‚’ innerHTML ã«åŸ‹ã‚è¾¼ã‚€å‰ã«ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã™ã‚‹
  function esc(s) {
    const d = document.createElement('div');
    d.textContent = s;
    return d.innerHTML;
  }

  // å…¨è§’æ•°å­—ï¼ˆIME å¤‰æ›å¾Œãªã©ï¼‰ã‚’åŠè§’ã«çµ±ä¸€ã—ã¦æ•°å€¤ã ã‘è¿”ã™
  function zenToHan(str) {
    return str
      .replace(/[ï¼-ï¼™]/g, c => String.fromCharCode(c.charCodeAt(0) - 0xFEE0))
      .replace(/[^0-9]/g, '');
  }

  // â”€â”€ ç”»é¢åˆ‡æ›¿ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function showScreen(id) {
    ['screen-start', 'screen-upload', 'screen-main'].forEach(s => {
      const el = $(s);
      if (el) el.style.display = 'none';
    });
    const target = $(id);
    if (target) target.style.display = id === 'screen-upload' ? 'flex' : 'block';
  }

  // â”€â”€ OCR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  /**
   * ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’å—ã‘å–ã‚Šã€ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºã¨ OCR ã‚’é–‹å§‹ã™ã‚‹ã€‚
   * fileInput / cameraInput / startCameraInput ã® change ã‚¤ãƒ™ãƒ³ãƒˆã‹ã‚‰å‘¼ã¶å…±é€šã‚¨ãƒ³ãƒˆãƒªã€‚
   */
  function handleFile(file) {
    if (!file || !file.type.startsWith('image/')) return;
    selectedFile = file;

    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºï¼ˆFileReader ã§ data URL ã«å¤‰æ›ã—ã¦ <img> ã«æ¸¡ã™ï¼‰
    const reader = new FileReader();
    reader.onload = e => {
      $('previewImg').src = e.target.result;
      $('uploadZone').classList.add('has-image');
    };
    reader.readAsDataURL(file);

    analyzeReceipt(file);
  }

  /**
   * ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç´”ç²‹ãª Base64 æ–‡å­—åˆ—ã«å¤‰æ›ã™ã‚‹ã€‚
   * Vision API ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã«åŸ‹ã‚è¾¼ã‚€ãŸã‚ã€data:... ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã¯é™¤å»ã™ã‚‹ã€‚
   */
  function fileToBase64(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload  = e => resolve(e.target.result.split(',')[1]); // "data:image/...;base64," ã‚’é™¤å»
      reader.onerror = () => reject(new Error('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ'));
      reader.readAsDataURL(file);
    });
  }

  /**
   * Google Cloud Vision APIï¼ˆTEXT_DETECTIONï¼‰ã§ OCR ã‚’å®Ÿè¡Œã—ã€çµæœã‚’ç”»é¢ã«è¡¨ç¤ºã™ã‚‹ã€‚
   *
   * APIã‚­ãƒ¼ã¯ URL ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ ?APIkey=... ã‹ã‚‰å–å¾—ã™ã‚‹ã€‚
   * ã‚­ãƒ¼ãŒæœªæŒ‡å®šã®å ´åˆã¯ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã—ã¦å‡¦ç†ã‚’ä¸­æ–­ã™ã‚‹ã€‚
   *
   * å‡¦ç†ãƒ•ãƒ­ãƒ¼:
   *   1. URLSearchParams ã‹ã‚‰ APIã‚­ãƒ¼ã‚’å–å¾—
   *   2. ç”»åƒã‚’ Base64 ã«å¤‰æ›
   *   3. Vision API ã« POST â†’ fullTextAnnotation.text ã‚’å–å¾—
   *   4. parseReceiptItems() ã§ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰å•†å“ãƒ»é‡‘é¡ã‚’æŠ½å‡º
   *   5. çµæœã‚’ç”»é¢ã«è¡¨ç¤ºã—ã€å‰²ã‚Šå‹˜ãƒªã‚¹ãƒˆã¸è¿½åŠ ã™ã‚‹ãƒœã‚¿ãƒ³ã‚’å‡ºã™
   */
  async function analyzeReceipt(file) {
    const btnAnalyze = $('btnAnalyze');
    const ocrResult  = $('ocrResult');
    const ocrText    = $('ocrText');
    const ocrParsed  = $('ocrParsedList');
    const btnGoMain  = $('btnGoMain');

    // è§£æä¸­ UI ã«ãƒªã‚»ãƒƒãƒˆ
    btnAnalyze.disabled     = true;
    btnAnalyze.textContent  = 'è§£æä¸­â€¦';
    ocrResult.style.display = 'block';
    ocrText.textContent     = 'è§£æã—ã¦ã„ã¾ã™â€¦';
    ocrParsed.innerHTML     = '';
    btnGoMain.style.display = 'none';

    try {
      // 1. URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰ APIã‚­ãƒ¼ã‚’å–å¾—
      const apiKey = new URLSearchParams(window.location.search).get('APIkey');
      if (!apiKey) {
        throw new Error('APIã‚­ãƒ¼ãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚URLã« ?APIkey=YOUR_KEY ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚');
      }

      // 2. ç”»åƒã‚’ Base64 ã«å¤‰æ›
      const base64Image = await fileToBase64(file);

      // 3. Vision API ã¸ POST
      const endpoint = `https://vision.googleapis.com/v1/images:annotate?key=${apiKey}`;
      const response = await fetch(endpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          requests: [{
            image:    { content: base64Image },
            features: [{ type: 'TEXT_DETECTION' }],
          }],
        }),
      });

      if (!response.ok) {
        const err = await response.json().catch(() => ({}));
        const msg = err?.error?.message ?? `HTTP ${response.status}`;
        throw new Error(`Vision API ã‚¨ãƒ©ãƒ¼: ${msg}`);
      }

      // 4. fullTextAnnotation.text ã‚’å–å¾—
      const data       = await response.json();
      const annotation = data?.responses?.[0]?.fullTextAnnotation;
      const text       = annotation?.text ?? '';

      // ç”Ÿãƒ†ã‚­ã‚¹ãƒˆã‚’ãã®ã¾ã¾è¡¨ç¤ºï¼ˆãƒ‡ãƒãƒƒã‚°ãƒ»ç¢ºèªç”¨ï¼‰
      ocrText.textContent = text.trim() || 'ï¼ˆãƒ†ã‚­ã‚¹ãƒˆã‚’æ¤œå‡ºã§ãã¾ã›ã‚“ã§ã—ãŸï¼‰';

      // 5. å•†å“ãƒ»é‡‘é¡ãƒ»åº—åãƒ»åˆè¨ˆã‚’ãƒ‘ãƒ¼ã‚¹ã—ã¦ä¸€è¦§åŒ–
      currentParsedResult = parseReceiptItems(text); // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ä¿æŒ

      if (currentParsedResult.items.length > 0) {
        const metaRows = [
          currentParsedResult.storeName   ? `<div class="ocr-parsed-item ocr-meta"><span>åº—å</span><span>${esc(currentParsedResult.storeName)}</span></div>` : '',
          currentParsedResult.totalAmount ? `<div class="ocr-parsed-item ocr-meta"><span>åˆè¨ˆ</span><span>Â¥${currentParsedResult.totalAmount.toLocaleString()}</span></div>` : '',
        ].join('');
        ocrParsed.innerHTML = metaRows + currentParsedResult.items
          .map(it =>
            `<div class="ocr-parsed-item">`
            + `<span>${esc(it.name)}</span>`
            + `<span>Â¥${it.price.toLocaleString()}</span>`
            + `</div>`
          )
          .join('');
        btnGoMain.textContent   = 'å‰²ã‚Šå‹˜ãƒªã‚¹ãƒˆã«è¿½åŠ ã—ã¦é€²ã‚€ â†’';
        btnGoMain.style.display = 'block';
        btnGoMain.onclick = () => {
          console.log('[btnGoMain] ä¿å­˜ãƒ‡ãƒ¼ã‚¿:', currentParsedResult);
          localStorage.setItem('currentParsedResult', JSON.stringify(currentParsedResult));
          items.length = 0; // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¦OCRçµæœã®ã¿åæ˜ 
          currentParsedResult.items.forEach(it => {
            const checked = {};
            MEMBERS.forEach(m => (checked[m.key] = false));
            items.push({ id: Date.now() + (Math.random() * 1000 | 0), name: it.name, price: it.price, checked });
          });
          render();
          showScreen('screen-main');
        };
      } else {
        ocrParsed.innerHTML     = '<div class="ocr-empty">å•†å“ã¨é‡‘é¡ã‚’è‡ªå‹•æ¤œå‡ºã§ãã¾ã›ã‚“ã§ã—ãŸã€‚æ‰‹å‹•ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</div>';
        btnGoMain.textContent   = 'æ‰‹å‹•ã§å…¥åŠ›ã™ã‚‹ â†’';
        btnGoMain.style.display = 'block';
        btnGoMain.onclick       = () => showScreen('screen-main');
      }
    } catch (err) {
      ocrText.textContent = `ã‚¨ãƒ©ãƒ¼: ${err.message ?? 'OCRå‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚'}`;
      ocrResult.style.display = 'block';
    } finally {
      btnAnalyze.disabled    = false;
      btnAnalyze.textContent = 'å†è§£æã™ã‚‹';
    }
  }

  /**
   * OCR ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰åº—åãƒ»åˆè¨ˆãƒ»å•†å“ä¸€è¦§ã‚’æŠ½å‡ºã—ã¦è¿”ã™ã€‚
   *
   * @param {string} text - Vision API ã® fullTextAnnotation.text
   * @returns {{ storeName: string, totalAmount: number, items: {name:string, price:number}[] }}
   *
   * å•†å“æŠ½å‡ºã¯1è¡Œå®Œçµå‹ã¨2è¡Œæ§‹é€ å‹ã®ä¸¡æ–¹ã«å¯¾å¿œã™ã‚‹:
   *   ãƒ‘ã‚¿ãƒ¼ãƒ³â‘ ï¼ˆ1è¡Œå®Œçµï¼‰: ã€Œã‚³ã‚¢ãƒ©ãƒ‘ãƒ³ 190ã€â†’ è¡Œæœ«ä¾¡æ ¼ + æ–‡å­—ã‚ã‚Š + @ãªã—
   *   ãƒ‘ã‚¿ãƒ¼ãƒ³â‘¡ï¼ˆ2è¡Œæ§‹é€ ï¼‰: ã€Œã‚­ãƒ£ãƒ©ãƒ¡ãƒ«ãƒãƒƒãƒ—ã‚³ãƒ¼ãƒ³ã€â†’ã€Œ@150 1ç‚¹ 150ã€â†’ pendingItemName ã§é€£çµ
   */
  function parseReceiptItems(text) {
    const lines = text.split('\n').map(raw =>
      raw
        .replace(/[ï¼-ï¼™]/g, c => String.fromCharCode(c.charCodeAt(0) - 0xFEE0))
        .replace(/ã€€/g, ' ')
        .trim()
    ).filter(Boolean);

    // â”€â”€ åº—åæŠ½å‡º â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // TELã‚ˆã‚Šä¸Šã®è¡Œã‹ã‚‰ã€ä½æ‰€ãƒ»æ•°å­—éå¤šã‚’é™¤ã„ãŸæœ€åˆã®æ–‡å­—ãƒ–ãƒ­ãƒƒã‚¯
    let storeName = '';
    const telIdx = lines.findIndex(l => /TEL|tel|Tel|0120|\d{2,4}-\d{2,4}-\d{4}/.test(l));
    const headerLines = telIdx >= 0 ? lines.slice(0, telIdx) : lines.slice(0, Math.min(6, lines.length));
    const isAddress = l => /[éƒ½é“åºœçœŒå¸‚åŒºç”ºæ‘]|ã€’|\d{1,4}-\d{1,4}/.test(l);
    for (const l of headerLines) {
      if (/^\d+$/.test(l)) continue;
      if (isAddress(l)) continue;
      if ((l.match(/\d/g) || []).length / l.length > 0.5) continue;
      if (/[\u3040-\u30FF\u4E00-\u9FFF]/.test(l) || /[A-Za-z]/.test(l)) {
        storeName = l.trim();
        break;
      }
    }

    // â”€â”€ åˆè¨ˆé‡‘é¡æŠ½å‡º â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ã€Œåˆè¨ˆã€ã‚’å«ã‚€è¡Œã®æœ«å°¾é‡‘é¡ã‚’åé›†ã—æœ€å¤§å€¤ã‚’æ¡ç”¨
    let totalAmount = 0;
    for (const l of lines) {
      if (!/åˆè¨ˆ/.test(l)) continue;
      const m = l.match(/[Â¥ï¿¥]?\s*([\d,]+)\s*å††?\s*$/);
      if (m) {
        const v = parseInt(m[1].replace(/,/g, ''), 10);
        if (v > totalAmount) totalAmount = v;
      }
    }

    // â”€â”€ å•†å“æŠ½å‡º â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const SKIP = /å°è¨ˆ|åˆè¨ˆ|æ¶ˆè²»ç¨|å†…ç¨|å¤–ç¨|ç¨ç‡|ç¨é¡|ãŠé‡£|ã¤ã‚Š|ãŠé |é ã‚Š|ãƒã‚¤ãƒ³ãƒˆ|åˆ©ç”¨|ãŠè²·ä¸Šç‚¹æ•°|ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ|ç¾é‡‘|å‰²å¼•|å€¤å¼•|ã‚¯ãƒ¼ãƒãƒ³|æ”¯æ‰•|ç™»éŒ²ç•ªå·/;
    const TEL  = /TEL|tel|Tel|0120|\d{2,4}-\d{2,4}-\d{4}/;
    const seen  = new Set();
    const items = [];
    let pendingItemName = null; // 2è¡Œæ§‹é€ å‹ã®å•†å“åã‚’ä¸€æ™‚ä¿æŒ

    // è¡Œæœ«ã®æœ‰åŠ¹ä¾¡æ ¼ï¼ˆ10ã€œ99,999å††ï¼‰ã‚’è¿”ã™ã€‚ãªã‘ã‚Œã° null
    const extractPrice = line => {
      const m = line.match(/[Â¥ï¿¥]?\s*(\d{1,2},\d{3}|\d{2,4})\s*å††?\s*$/);
      if (!m) return null;
      const v = parseInt(m[1].replace(',', ''), 10);
      return (v >= 10 && v < 100_000) ? v : null;
    };

    // æ—¥æœ¬èªæ–‡å­—ï¼ˆã²ã‚‰ãŒãªãƒ»ã‚«ã‚¿ã‚«ãƒŠãƒ»æ¼¢å­—ï¼‰ã‚’å«ã‚€ã‹
    const hasJapanese = l => /[\u3040-\u30FF\u4E00-\u9FFF]/.test(l);

    // æ—¥æœ¬èªãƒ»è‹±å­—ã‚’å«ã‚€ã‹
    const hasText = l => hasJapanese(l) || /[A-Za-z]/.test(l);

    // å‡¦ç†å¯¾è±¡å¤–ã¨åˆ¤å®šã™ã‚‹è¡Œ
    const isExcluded = line =>
      SKIP.test(line) ||
      TEL.test(line) ||
      /^\d+$/.test(line) ||                          // æ•°å­—ã®ã¿
      /\d{10,}/.test(line) ||                        // ç™»éŒ²ç•ªå·ãƒ»é•·ã„é€£ç¶šæ•°å­—ï¼ˆ10æ¡ä»¥ä¸Šï¼‰
      /\d{4}\/\d{2}\/\d{2}/.test(line) ||            // æ—¥ä»˜ï¼ˆ2024/01/23ï¼‰
      /\d{2}:\d{2}/.test(line) ||                    // æ™‚åˆ»ï¼ˆ12:34ï¼‰
      /^[XxÃ—ï¼¸ï¼Š*\s]+$/.test(line) ||               // X ã‚„ * ã®ã¿ã®è¡Œï¼ˆãƒã‚¹ã‚¯æ–‡å­—åˆ—ï¼‰
      /(\d{4}[\s\-]){3}\d{4}/.test(line) ||          // ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰ç•ªå·ï¼ˆ4-4-4-4ï¼‰
      /[Xx]{4}[\s\-][Xx]{4}/.test(line);             // ãƒã‚¹ã‚¯æ¸ˆã¿ã‚«ãƒ¼ãƒ‰ç•ªå·ï¼ˆXXXX XXXX...ï¼‰

    // å•†å“åã®ãƒã‚¤ã‚ºé™¤å»
    const cleanName = raw => {
      let name = raw;
      name = name.replace(/^[ï¼Š*]\s*/, '');                            // â‘  å…ˆé ­ã® * ã‚’é™¤å»ï¼ˆè»½æ¸›ç¨ç‡ãƒãƒ¼ã‚¯ãªã©ï¼‰
      name = name.replace(/^\d{8,13}\s*/, '');                        // â‘¡ JANã‚³ãƒ¼ãƒ‰
      name = name.replace(/^\d{3,7}[â€»\s]\s*/, '');                   // â‘¢ çŸ­ã„æ•°å­—ã‚³ãƒ¼ãƒ‰
      name = name.replace(/^\d+\s+/, '');                             // â‘£ å…ˆé ­ã®å­¤ç«‹æ•°å­—
      name = name.replace(/[â€»\\ï¼¼Ã—Ã·â˜†â˜…â—â—‹â– â–¡â—‡â—†â–¶â–·â–ºâ—€â—â–²â–¼â–³â–½ï¼Š*~ï½ï½œ|]+/g, ''); // â‘¤ è¨˜å·
      name = name
        .replace(/^[^\w\u3040-\u30FF\u4E00-\u9FFF]+/, '')            // â‘¥ å…ˆé ­ãƒã‚¤ã‚º
        .replace(/[^\w\u3040-\u30FF\u4E00-\u9FFFï¼‰)ãƒ¼]+$/, '');      // â‘¥ æœ«å°¾ãƒã‚¤ã‚º
      return name.replace(/\s{2,}/g, ' ').trim();                     // â‘¦ é€£ç¶šã‚¹ãƒšãƒ¼ã‚¹
    };

    const pushItem = (name, price) => {
      const cleaned = cleanName(name);
      if (!cleaned) return;
      const key = `${cleaned}:${price}`;
      if (seen.has(key)) return;
      seen.add(key);
      items.push({ name: cleaned, price });
    };

    for (const line of lines) {
      // é™¤å¤–è¡Œã¯ãƒšãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã‚‚ãƒªã‚»ãƒƒãƒˆ
      if (isExcluded(line)) { pendingItemName = null; continue; }

      const price       = extractPrice(line);
      const lineHasText = hasText(line);
      const isAtLine    = /@\d+/.test(line); // å˜ä¾¡æƒ…å ±ï¼ˆ@150 ãªã©ï¼‰ã‚’å«ã‚€è¡Œ

      // â”€â”€ ã‚±ãƒ¼ã‚¹1: @æ•°å­—ã‚’å«ã‚€ â†’ 2è¡Œæ§‹é€ ã®ä¾¡æ ¼è¡Œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      if (isAtLine) {
        if (pendingItemName !== null && price !== null) {
          pushItem(pendingItemName, price);
        }
        pendingItemName = null;
        continue;
      }

      // â”€â”€ ã‚±ãƒ¼ã‚¹2: 1è¡Œå®Œçµå‹ï¼ˆè¡Œæœ«ã«ä¾¡æ ¼ã‚ã‚Š + æ–‡å­—ã‚ã‚Š + @ãªã—ï¼‰â”€â”€
      if (price !== null && lineHasText) {
        const priceMatch = line.match(/[Â¥ï¿¥]?\s*(\d{1,2},\d{3}|\d{2,4})\s*å††?\s*$/);
        const namepart   = line.slice(0, line.length - priceMatch[0].length).trim();
        pendingItemName  = null;
        if (namepart) pushItem(namepart, price);
        continue;
      }

      // â”€â”€ ã‚±ãƒ¼ã‚¹3: ä¾¡æ ¼ã®ã¿è¡Œï¼ˆè¡Œæœ«ã«ä¾¡æ ¼ã‚ã‚Š + æ–‡å­—ãªã—ï¼‰â†’ 2è¡Œæ§‹é€ ã®ä¾¡æ ¼è¡Œ â”€â”€
      if (price !== null && !lineHasText) {
        if (pendingItemName !== null) pushItem(pendingItemName, price);
        pendingItemName = null;
        continue;
      }

      // â”€â”€ ã‚±ãƒ¼ã‚¹4: å•†å“åå€™è£œè¡Œï¼ˆæ—¥æœ¬èªã‚’å«ã‚€ + è¡Œæœ«ã«ä¾¡æ ¼ãªã—ï¼‰â”€â”€â”€
      // æ—¥æœ¬èªæ–‡å­—ã‚’å«ã‚€è¡Œã®ã¿å•†å“åå€™è£œã¨ã™ã‚‹ï¼ˆè‹±æ•°å­—ã®ã¿ã®è¡Œã¯é™¤å¤–ï¼‰
      if (lineHasText && hasJapanese(line)) {
        pendingItemName = line;
        continue;
      }

      // â”€â”€ ã‚±ãƒ¼ã‚¹5: ãã®ä»–ï¼ˆæ•°å­—ã®ã¿ãªã©ï¼‰â†’ ãƒªã‚»ãƒƒãƒˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      pendingItemName = null;
    }

    return { storeName, totalAmount, items };
  }

  // â”€â”€ å•†å“ãƒªã‚¹ãƒˆæ“ä½œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function addItem() {
    const name  = $('itemName').value.trim();
    const price = parseInt($('itemPrice').value, 10);
    if (!name)                     { $('itemName').focus();  return; }
    if (isNaN(price) || price < 0) { $('itemPrice').focus(); return; }

    const checked = {};
    MEMBERS.forEach(m => (checked[m.key] = false));
    items.push({ id: Date.now(), name, price, checked });

    $('itemName').value  = '';
    $('itemPrice').value = '';
    $('itemName').focus();
    render();
  }

  function deleteItem(id) {
    const i = items.findIndex(x => x.id === id);
    if (i !== -1) { items.splice(i, 1); render(); }
  }

  function toggle(itemId, key) {
    const item = items.find(x => x.id === itemId);
    if (item) { item.checked[key] = !item.checked[key]; render(); }
  }

  // å„ãƒ¡ãƒ³ãƒãƒ¼ã®è² æ‹…é¡ã‚’è¨ˆç®—ã™ã‚‹ã€‚
  // 1å††æœªæº€ã®ç«¯æ•°ã¯å…ˆé ­ã®ãƒ¡ãƒ³ãƒãƒ¼ã‹ã‚‰é †ã«1å††ãšã¤ä¸Šä¹—ã›ã—ã¦å®Œå…¨ã«åˆ†é…ã™ã‚‹ã€‚
  // ãƒã‚§ãƒƒã‚¯ãªã—ã®å ´åˆã¯ã€Œè‡ªåˆ†ã€ã«å…¨é¡ã‚’åŠ ç®—ã™ã‚‹ã€‚
  function calcShares(item) {
    const shares = {};
    MEMBERS.forEach(m => (shares[m.key] = 0));
    const sel = MEMBERS.filter(m => item.checked[m.key]);
    if (sel.length === 0) { shares.me = item.price; return shares; }
    const base = Math.floor(item.price / sel.length);
    const rem  = item.price % sel.length;
    sel.forEach((m, i) => { shares[m.key] = base + (i < rem ? 1 : 0); });
    return shares;
  }

  /**
   * ãƒ¬ã‚·ãƒ¼ãƒˆåˆè¨ˆã«åŸºã¥ãå‰²ã‚Šå‹˜è¨ˆç®—ã€‚
   *
   * å•†å“æŒ‰åˆ†ã®åˆè¨ˆã¨ãƒ¬ã‚·ãƒ¼ãƒˆåˆè¨ˆã®å·®é¡ï¼ˆç¨ãƒ»å€¤å¼•ãç«¯æ•°ãªã©ï¼‰ã‚’
   * å„äººã®è³¼å…¥é‡‘é¡æ¯”ç‡ã§æŒ‰åˆ†ã—ã€å››æ¨äº”å…¥ã®ç«¯æ•°ã¯æ”¯æ‰•è€…ã«é›†ç´„ã™ã‚‹ã€‚
   * æœ€çµ‚çš„ã«å…¨å“¡ã®åˆè¨ˆãŒãƒ¬ã‚·ãƒ¼ãƒˆåˆè¨ˆã¨å®Œå…¨ä¸€è‡´ã™ã‚‹ã“ã¨ã‚’ä¿è¨¼ã™ã‚‹ã€‚
   *
   * @param {Array}  itemList     - items é…åˆ—ï¼ˆprice + checked ã‚’æŒã¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼‰
   * @param {number} receiptTotal - ãƒ¬ã‚·ãƒ¼ãƒˆåˆè¨ˆé‡‘é¡ï¼ˆparseReceiptItems ã® totalAmountï¼‰
   * @param {string} [payer]      - ç«¯æ•°èª¿æ•´ã‚’å—ã‘ã‚‹ãƒ¡ãƒ³ãƒãƒ¼ã‚­ãƒ¼ï¼ˆdefault: 'me'ï¼‰
   * @returns {Object}            - ãƒ¡ãƒ³ãƒãƒ¼ã‚­ãƒ¼ã”ã¨ã®æœ€çµ‚è² æ‹…é¡ { me, a, b, c }
   */
  function calcSplitByReceipt(itemList, receiptTotal, payer = 'me') {
    const keys = MEMBERS.map(m => m.key);

    // 1. å„äººã®å•†å“åˆè¨ˆï¼ˆæ—¢å­˜ã® calcShares ã‚’å†åˆ©ç”¨ï¼‰
    const raw = {};
    keys.forEach(k => (raw[k] = 0));
    for (const item of itemList) {
      const sh = calcShares(item);
      keys.forEach(k => (raw[k] += sh[k]));
    }

    // 2. å·®é¡ç®—å‡ºï¼ˆç¨ãƒ»ç«¯æ•°ãƒ»å€¤å¼•ããªã©ã«ã‚ˆã‚‹ã‚ºãƒ¬ï¼‰
    const itemsTotal = keys.reduce((s, k) => s + raw[k], 0);
    const diff = receiptTotal - itemsTotal;

    if (diff === 0) return { ...raw };

    // 3. å·®é¡ã‚’è³¼å…¥é‡‘é¡æ¯”ç‡ã§æŒ‰åˆ† â†’ å››æ¨äº”å…¥
    const adj = {};
    if (itemsTotal > 0) {
      keys.forEach(k => {
        adj[k] = Math.round((raw[k] / itemsTotal) * diff);
      });
    } else {
      // å…¨å“¡0å††ï¼ˆå•†å“ãªã—ï¼‰â†’ æ”¯æ‰•è€…ãŒå…¨é¡è² æ‹…
      keys.forEach(k => (adj[k] = 0));
      adj[payer] = diff;
    }

    // 4. å››æ¨äº”å…¥ã«ã‚ˆã‚‹ç«¯æ•°ã‚ºãƒ¬ã‚’æ”¯æ‰•è€…ã«åŠ æ¸›
    const adjSum = keys.reduce((s, k) => s + adj[k], 0);
    adj[payer] += diff - adjSum;

    // 5. æœ€çµ‚é‡‘é¡ï¼ˆå…¨å“¡åˆè¨ˆ === receiptTotal ã‚’ä¿è¨¼ï¼‰
    const finals = {};
    keys.forEach(k => (finals[k] = raw[k] + adj[k]));
    return finals;
  }

  // å•†å“ã‚«ãƒ¼ãƒ‰ã«è¡¨ç¤ºã™ã‚‹å‰²ã‚Šå‹˜ãƒ’ãƒ³ãƒˆæ–‡ã‚’è¿”ã™
  function hint(item) {
    const sel = MEMBERS.filter(m => item.checked[m.key]);
    if (sel.length === 0) return '<b>è‡ªåˆ†ã«å…¨é¡åŠ ç®—</b>';
    return `${sel.map(m => m.label).join(' + ')} ã§ <b>${sel.length}äººå‰²ã‚Š</b>`;
  }

  function render() {
    if (items.length === 0) {
      $('itemList').innerHTML      = '<div class="empty-msg">å•†å“ã‚’è¿½åŠ ã™ã‚‹ã¨ã€ã“ã“ã«ä¸€è¦§ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div>';
      $('resultContent').innerHTML = '<div class="result-empty">å•†å“ã‚’è¿½åŠ ã™ã‚‹ã¨ã“ã“ã«çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div>';
      return;
    }

    $('itemList').innerHTML = items.map(item => {
      const pills = MEMBERS.map(m => {
        const uid = `c_${item.id}_${m.key}`;
        const chk = item.checked[m.key] ? 'checked' : '';
        return `<span class="pill">`
          + `<input type="checkbox" id="${uid}" ${chk} onchange="toggle(${item.id},'${m.key}')">`
          + `<label for="${uid}" class="${m.cl}">${esc(m.label)}</label>`
          + `</span>`;
      }).join('');

      return `<div class="item-card">`
        + `<div class="item-top">`
        +   `<div>`
        +     `<div class="item-name">${esc(item.name)}</div>`
        +     `<span class="item-price-badge">Â¥${item.price.toLocaleString()}</span>`
        +   `</div>`
        +   `<button class="btn-del" onclick="deleteItem(${item.id})" title="å‰Šé™¤">&times;</button>`
        + `</div>`
        + `<div class="checks">${pills}</div>`
        + `<div class="split-note">${hint(item)}</div>`
        + `</div>`;
    }).join('');

    const totals = {};
    MEMBERS.forEach(m => (totals[m.key] = 0));

    const rows = items.map(item => {
      const sh = calcShares(item);
      MEMBERS.forEach(m => (totals[m.key] += sh[m.key]));
      const cells = MEMBERS.map(m => {
        const v = sh[m.key];
        return `<td class="${v > 0 ? 'val' : 'zero'}">${v > 0 ? 'Â¥' + v.toLocaleString() : '-'}</td>`;
      }).join('');
      return `<tr onclick="this.classList.toggle('expanded')">`
        + `<td><span class="cell-name">${esc(item.name)}</span></td>${cells}`
        + `</tr>`;
    }).join('');

    const boxes = MEMBERS.map(m =>
      `<div class="total-box ${m.box}">`
      + `<div class="total-name">${esc(m.label)}</div>`
      + `<div class="total-yen">Â¥${totals[m.key].toLocaleString()}</div>`
      + `</div>`
    ).join('');

    const ths = MEMBERS.map(m => `<th class="${m.hcl}">${esc(m.label)}</th>`).join('');
    const fts = MEMBERS.map(m => `<td class="${m.fcl}">Â¥${totals[m.key].toLocaleString()}</td>`).join('');

    $('resultContent').innerHTML =
      `<div class="totals-grid">${boxes}</div>`
      + `<table class="detail-table">`
      +   `<thead><tr><th>å•†å“</th>${ths}</tr></thead>`
      +   `<tbody>${rows}</tbody>`
      +   `<tfoot><tr><td>åˆè¨ˆ</td>${fts}</tr></tfoot>`
      + `</table>`;
  }

  // â”€â”€ ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  // IME ç¢ºå®šå¾Œã«å…¨è§’æ•°å­—ã‚’åŠè§’ã«è‡ªå‹•å¤‰æ›ï¼ˆã‚¹ãƒãƒ›æ—¥æœ¬èªã‚­ãƒ¼ãƒœãƒ¼ãƒ‰å¯¾ç­–ï¼‰
  $('itemPrice').addEventListener('compositionend', function () {
    const converted = zenToHan(this.value);
    if (converted) this.value = converted;
  });

  // å•†å“ã‚’è¿½åŠ  / Enter ã‚­ãƒ¼ã§ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ç§»å‹•
  $('btnAdd').addEventListener('click', addItem);
  $('itemPrice').addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); addItem(); } });
  $('itemName').addEventListener('keydown',  e => { if (e.key === 'Enter') { e.preventDefault(); $('itemPrice').focus(); } });

  // å…¨å•†å“ã‚¯ãƒªã‚¢ï¼ˆç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚ã‚Šï¼‰
  $('btnClear').addEventListener('click', () => {
    if (items.length === 0) return;
    if (confirm('ã™ã¹ã¦ã®å•†å“ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')) { items.length = 0; render(); }
  });

  // ã‚‚ã©ã‚‹ãƒœã‚¿ãƒ³ â†’ ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ã¸
  $('btnBack').addEventListener('click', () => showScreen('screen-start'));

  // ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ã®ã€Œãƒ¬ã‚·ãƒ¼ãƒˆã‚’èª­ã¿è¾¼ã‚€ã€â†’ ã‚«ãƒ¡ãƒ©èµ·å‹•
  $('btnGoUpload').addEventListener('click', () => $('startCameraInput').click());

  // ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ã§ã‚«ãƒ¡ãƒ©æ’®å½± â†’ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç”»é¢ã‚’é–‹ã„ã¦ OCR è‡ªå‹•é–‹å§‹
  $('startCameraInput').addEventListener('change', e => {
    const file = e.target.files[0];
    if (file) { showScreen('screen-upload'); handleFile(file); }
  });

  // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç”»é¢ã®ã‚µãƒ–ãƒœã‚¿ãƒ³ï¼ˆãƒ©ã‚¤ãƒ–ãƒ©ãƒª / ã‚«ãƒ¡ãƒ©ï¼‰
  $('btnLibrary').addEventListener('click', () => $('fileInput').click());
  $('btnCamera').addEventListener('click',  () => $('cameraInput').click());

  // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ â†’ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º & OCR è‡ªå‹•é–‹å§‹
  $('fileInput').addEventListener('change',   e => { if (e.target.files[0]) handleFile(e.target.files[0]); });
  $('cameraInput').addEventListener('change', e => { if (e.target.files[0]) handleFile(e.target.files[0]); });

  // ã€Œå†è§£æã™ã‚‹ã€ãƒœã‚¿ãƒ³ï¼ˆOCR å®Œäº†å¾Œã«æœ‰åŠ¹ã«ãªã‚‹ï¼‰
  $('btnAnalyze').addEventListener('click', () => {
    if (selectedFile) analyzeReceipt(selectedFile);
  });
</script>

</div><!-- /screen-main -->
<script>
  // Service Worker ã‚’ç™»éŒ²ã—ã¦ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å¯¾å¿œãƒ»PWA ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’æœ‰åŠ¹ã«ã™ã‚‹ã€‚
  // HTTPSï¼ˆGitHub Pagesï¼‰ã¾ãŸã¯ localhost ã§ã®ã¿å‹•ä½œã™ã‚‹ã€‚
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('service-worker.js')
      .then(() => console.log('Service Worker registered'));
  }
</script>
</body>
</html>
