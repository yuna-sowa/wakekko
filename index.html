<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ã‚ã‘ã£ã“ - å‰²ã‚Šå‹˜ã‚¢ãƒ—ãƒª</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700;900&display=swap" rel="stylesheet">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#F4A987">
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Zen Maru Gothic', 'Hiragino Kaku Gothic ProN', sans-serif;
      background: #FFF5F5;
      color: #333333;
      min-height: 100vh;
      line-height: 1.75;
    }

    /* ========== ãƒ˜ãƒƒãƒ€ãƒ¼ / ãƒ­ã‚´ ========== */
    .header {
      background: #fff;
      text-align: center;
      padding: 40px 16px 36px;
      border-bottom: 2px solid #FFE0E0;
    }
    .logo {
      font-size: 30px;
      font-weight: 900;
      color: #E8707A;
      letter-spacing: 8px;
    }
    .logo-sub {
      font-size: 12px;
      font-weight: 500;
      color: #999;
      margin-top: 6px;
      letter-spacing: 2px;
    }

    /* ========== 2ã‚«ãƒ©ãƒ  ========== */
    .layout {
      display: flex;
      gap: 32px;
      max-width: 1040px;
      margin: 0 auto;
      padding: 36px 32px;
      align-items: flex-start;
    }
    .col-left  { flex: 1; min-width: 0; }
    .col-right { flex: 1; min-width: 0; position: sticky; top: 36px; }

    /* ========== ã‚«ãƒ¼ãƒ‰å…±é€š ========== */
    .card {
      background: #fff;
      border-radius: 20px;
      padding: 28px;
      box-shadow: 0 2px 10px rgba(200,100,100,0.06);
      margin-bottom: 28px;
    }
    .card-title {
      font-size: 12px;
      font-weight: 700;
      color: #E8707A;
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 1px solid #FFE8E8;
      letter-spacing: 2px;
      text-transform: uppercase;
    }

    /* ========== ãƒ•ã‚©ãƒ¼ãƒ  ========== */
    .form-grid {
      display: flex;
      gap: 10px;
      margin-bottom: 16px;
    }
    .form-grid input[type="text"] {
      flex: 1;
      min-width: 0;
    }
    .form-grid input[type="number"] {
      width: 100px;
      flex-shrink: 0;
    }
    .form-grid input {
      padding: 13px 18px;
      border: 1.5px solid #F0D8D8;
      border-radius: 16px;
      font-size: 14px;
      font-family: inherit;
      color: #333333;
      background: #fff;
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .form-grid input:focus {
      border-color: #E8707A;
      box-shadow: 0 0 0 3px rgba(232,112,122,0.10);
    }
    .form-grid input::placeholder { color: #ccc; }

    .btn-add {
      width: 100%;
      padding: 14px;
      background: #E8707A;
      color: #fff;
      border: none;
      border-radius: 16px;
      font-size: 14px;
      font-weight: 700;
      font-family: inherit;
      cursor: pointer;
      letter-spacing: 2px;
      transition: background 0.2s, transform 0.15s;
      box-shadow: 0 3px 10px rgba(232,112,122,0.25);
    }
    .btn-add:hover { background: #D8606A; }
    .btn-add:active { transform: scale(0.98); }

    /* ========== å•†å“ã‚«ãƒ¼ãƒ‰ ========== */
    .item-card {
      background: #fff;
      border-radius: 18px;
      padding: 20px 22px;
      box-shadow: 0 2px 10px rgba(200,100,100,0.06);
      margin-bottom: 14px;
      animation: fadeUp 0.25s ease;
    }
    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(-6px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    .item-top {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 12px;
    }
    .item-top > div { min-width: 0; flex: 1; }
    .item-name {
      font-size: 14px;
      font-weight: 700;
      color: #333333;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
      word-break: break-all;
    }
    .item-price-badge {
      display: inline-block;
      font-size: 13px;
      font-weight: 700;
      color: #E8707A;
      background: #FFF0F0;
      padding: 4px 14px;
      border-radius: 10px;
      margin-top: 6px;
    }
    .btn-del {
      background: #FFF5F5;
      border: 1px solid #F0D8D8;
      color: #D0A8A8;
      width: 30px;
      height: 30px;
      border-radius: 10px;
      font-size: 15px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      flex-shrink: 0;
    }
    .btn-del:hover {
      background: #FFE0E0;
      border-color: #E09090;
      color: #C05050;
    }

    /* ========== ãƒ¡ãƒ³ãƒãƒ¼é¸æŠãƒ”ãƒ« ========== */
    .checks {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .pill input { display: none; }
    .pill label {
      display: inline-block;
      padding: 6px 18px;
      border: 1.5px solid #F0D8D8;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
      color: #bbb;
      cursor: pointer;
      transition: all 0.2s;
      user-select: none;
    }
    /* è‡ªåˆ†: ãƒ”ãƒ³ã‚¯ */
    .pill input:checked + label.cl-me {
      border-color: #F0A0A8;
      background: #FFF0F0;
      color: #C85060;
      font-weight: 700;
    }
    /* Aã•ã‚“: ãƒŸãƒ³ãƒˆ */
    .pill input:checked + label.cl-a {
      border-color: #90C8B8;
      background: #F0FAF6;
      color: #408070;
      font-weight: 700;
    }
    /* Bã•ã‚“: ãƒ©ãƒ™ãƒ³ãƒ€ãƒ¼ */
    .pill input:checked + label.cl-b {
      border-color: #C0B0D8;
      background: #F5F0FA;
      color: #685088;
      font-weight: 700;
    }
    /* Cã•ã‚“: ã‚¢ãƒ—ãƒªã‚³ãƒƒãƒˆ */
    .pill input:checked + label.cl-c {
      border-color: #E8C098;
      background: #FFF8F0;
      color: #A87030;
      font-weight: 700;
    }

    .split-note {
      font-size: 11px;
      color: #bbb;
      margin-top: 10px;
    }
    .split-note b { color: #E8707A; }

    .empty-msg {
      text-align: center;
      color: #ccc;
      padding: 48px 16px;
      font-size: 13px;
    }

    /* ========== çµæœ: åˆè¨ˆã‚«ãƒ¼ãƒ‰ ========== */
    .totals-grid {
      display: flex;
      gap: 10px;
      margin-bottom: 24px;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      padding-bottom: 4px;
    }
    .totals-grid::-webkit-scrollbar { display: none; }
    .total-box {
      flex: 1 0 auto;
      min-width: 80px;
      text-align: center;
      padding: 20px 14px;
      border-radius: 18px;
    }
    .total-box.me { background: #FFF0F0; }
    .total-box.a  { background: #F0FAF6; }
    .total-box.b  { background: #F5F0FA; }
    .total-box.c  { background: #FFF8F0; }

    .total-name {
      font-size: 11px;
      font-weight: 700;
      margin-bottom: 6px;
      letter-spacing: 1px;
    }
    .total-box.me .total-name { color: #C85060; }
    .total-box.a  .total-name { color: #408070; }
    .total-box.b  .total-name { color: #685088; }
    .total-box.c  .total-name { color: #A87030; }

    .total-yen {
      font-size: 26px;
      font-weight: 900;
      letter-spacing: -0.5px;
      white-space: nowrap;
      color: #333333;
    }

    /* ========== å†…è¨³ãƒ†ãƒ¼ãƒ–ãƒ« ========== */
    .detail-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      font-size: 13px;
    }
    .detail-table thead th {
      padding: 12px 6px;
      font-size: 11px;
      font-weight: 700;
      color: #bbb;
      text-align: center;
      border-bottom: 1px solid #FFE8E8;
    }
    .detail-table thead th:first-child { text-align: left; }
    .detail-table thead .h-me { color: #C85060; }
    .detail-table thead .h-a  { color: #408070; }
    .detail-table thead .h-b  { color: #685088; }
    .detail-table thead .h-c  { color: #A87030; }

    .detail-table tbody td {
      padding: 11px 6px;
      text-align: center;
      border-bottom: 1px solid #FFF0F0;
    }
    .detail-table tbody tr:last-child td { border-bottom: none; }
    .detail-table tbody td:first-child {
      text-align: left;
      font-weight: 500;
      color: #666666;
      font-size: 12px;
      max-width: 100px;
      word-break: break-all;
    }
    .detail-table tbody td:first-child .cell-name {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .detail-table tbody tr.expanded td:first-child .cell-name {
      -webkit-line-clamp: unset;
      overflow: visible;
    }
    .detail-table tbody tr { cursor: pointer; transition: background 0.15s; }
    .detail-table tbody tr:active { background: #FFF5F5; }
    .detail-table .val  { color: #333333; font-weight: 700; font-size: 14px; }
    .detail-table .zero { color: #ddd; }

    .detail-table tfoot td {
      padding: 14px 6px;
      font-weight: 900;
      font-size: 15px;
      text-align: center;
      border-top: 1px solid #FFE8E8;
      color: #333333;
    }
    .detail-table tfoot td:first-child { text-align: left; color: #666666; }

    .result-empty {
      text-align: center;
      color: #ccc;
      padding: 40px 0;
      font-size: 13px;
    }

    /* ========== ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ ========== */
    .btn-clear {
      width: 100%;
      padding: 13px;
      background: #fff;
      color: #bbb;
      border: 1.5px solid #F0D8D8;
      border-radius: 16px;
      font-size: 12px;
      font-weight: 700;
      font-family: inherit;
      cursor: pointer;
      letter-spacing: 1px;
      transition: all 0.2s;
    }
    .btn-clear:hover {
      background: #FFF5F5;
      border-color: #E8B0B0;
      color: #999;
    }

    /* ========== ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– ========== */
    @media (max-width: 720px) {
      .layout {
        flex-direction: column;
        padding: 24px 18px;
        gap: 24px;
      }
      .col-right { position: static; }
      .total-box { min-width: 72px; padding: 18px 10px; }
      .total-yen { font-size: 22px; }
      .form-grid { gap: 8px; }
      .header { padding: 32px 16px 28px; }
      .logo { font-size: 26px; letter-spacing: 6px; }
    }
    @media (max-width: 400px) {
      .logo { font-size: 22px; letter-spacing: 4px; }
      .logo-sub { font-size: 11px; }
      .totals-grid { gap: 8px; }
      .total-box { min-width: 68px; padding: 16px 8px; }
      .total-yen { font-size: 20px; }
      .form-grid { flex-wrap: wrap; }
      .form-grid input[type="text"] { flex: 1 1 100%; }
      .form-grid input[type="number"] { flex: 1 1 100%; width: auto; }
      .detail-table { font-size: 12px; }
      .detail-table .val { font-size: 13px; }
    }

    /* ========== ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ ========== */
    #screen-start {
      min-height: 100vh;
      background: #FAF8F4;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 48px 32px 64px;
    }
    #screen-main { display: none; }

    .start-illustration {
      font-size: 64px;
      margin-bottom: 8px;
      line-height: 1;
    }
    .start-logo {
      font-size: 48px;
      font-weight: 900;
      color: #C9673A;
      letter-spacing: 10px;
      margin-bottom: 16px;
    }
    .start-tagline {
      font-size: 14px;
      font-weight: 500;
      color: #A89080;
      letter-spacing: 1.5px;
      text-align: center;
      line-height: 1.9;
      margin-bottom: 64px;
    }
    .btn-start {
      width: 100%;
      max-width: 320px;
      padding: 20px 24px;
      background: #C9673A;
      color: #fff;
      border: none;
      border-radius: 24px;
      font-size: 16px;
      font-weight: 700;
      font-family: inherit;
      letter-spacing: 2px;
      cursor: pointer;
      box-shadow: 0 6px 20px rgba(201,103,58,0.30);
      transition: background 0.2s, transform 0.15s, box-shadow 0.2s;
    }
    .btn-start:hover {
      background: #B8592E;
      box-shadow: 0 8px 24px rgba(201,103,58,0.38);
    }
    .btn-start:active {
      transform: scale(0.97);
      box-shadow: 0 3px 12px rgba(201,103,58,0.25);
    }
    .start-footer {
      margin-top: 40px;
      font-size: 11px;
      color: #C8B8B0;
      letter-spacing: 1px;
    }

    /* ========== ãƒ¬ã‚·ãƒ¼ãƒˆèª­ã¿è¾¼ã¿ç”»é¢ ========== */
    #screen-upload {
      min-height: 100vh;
      background: #FAF8F4;
      display: none;
      flex-direction: column;
    }
    .upload-header {
      display: flex;
      align-items: center;
      padding: 20px 20px 0;
      position: relative;
      min-height: 52px;
    }
    .btn-back {
      background: none;
      border: none;
      font-family: inherit;
      font-size: 13px;
      font-weight: 700;
      color: #B09888;
      cursor: pointer;
      padding: 8px 4px;
      letter-spacing: 0.5px;
      z-index: 1;
    }
    .btn-back:active { opacity: 0.6; }
    .upload-page-title {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      font-size: 13px;
      font-weight: 700;
      color: #7A5C48;
      letter-spacing: 2.5px;
      white-space: nowrap;
    }
    .upload-body {
      flex: 1;
      padding: 28px 24px 56px;
      display: flex;
      flex-direction: column;
      gap: 18px;
      max-width: 480px;
      margin: 0 auto;
      width: 100%;
    }
    /* é¸æŠå‰: ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚¾ãƒ¼ãƒ³ */
    .upload-zone {
      display: block;
      width: 100%;
      aspect-ratio: 3 / 4;
      max-height: 52vh;
      border: 2px dashed #D4C4B8;
      border-radius: 24px;
      background: #FFFAF7;
      cursor: pointer;
      overflow: hidden;
      position: relative;
      transition: border-color 0.2s, background 0.2s;
    }
    .upload-zone:hover       { border-color: #C9673A; background: #FFF6EF; }
    .upload-zone.has-image   { border-style: solid; border-color: #C9673A; }
    .upload-zone-placeholder {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 12px;
      transition: opacity 0.2s;
    }
    .upload-zone.has-image .upload-zone-placeholder { opacity: 0; pointer-events: none; }
    .upload-zone-icon  { font-size: 52px; line-height: 1; }
    .upload-zone-label {
      font-size: 14px;
      font-weight: 700;
      color: #B09888;
      letter-spacing: 1.5px;
    }
    .upload-zone-sub {
      font-size: 11px;
      color: #C8B8B0;
      letter-spacing: 0.8px;
    }
    /* ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒ */
    .preview-img {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: none;
    }
    .upload-zone.has-image .preview-img { display: block; }
    /* é¸æŠæ¸ˆã¿ãƒãƒƒã‚¸ */
    .preview-badge {
      position: absolute;
      bottom: 14px;
      right: 14px;
      background: rgba(201,103,58,0.88);
      color: #fff;
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 1px;
      padding: 6px 14px;
      border-radius: 20px;
      display: none;
    }
    .upload-zone.has-image .preview-badge { display: block; }
    /* ãƒ©ã‚¤ãƒ–ãƒ©ãƒª / ã‚«ãƒ¡ãƒ© ãƒœã‚¿ãƒ³è¡Œ */
    .upload-btn-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .btn-upload-opt {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      padding: 18px 12px;
      background: #fff;
      border: 1.5px solid #E8D8CC;
      border-radius: 20px;
      font-family: inherit;
      font-size: 12px;
      font-weight: 700;
      color: #8A6858;
      letter-spacing: 1px;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 2px 8px rgba(180,130,100,0.06);
    }
    .btn-upload-opt:hover  { background: #FFF5EE; border-color: #C9673A; color: #C9673A; }
    .btn-upload-opt:active { transform: scale(0.97); }
    .btn-upload-opt-icon   { font-size: 26px; line-height: 1; }
    /* è§£æãƒœã‚¿ãƒ³ */
    .btn-analyze {
      width: 100%;
      padding: 20px 24px;
      background: #C9673A;
      color: #fff;
      border: none;
      border-radius: 24px;
      font-size: 16px;
      font-weight: 700;
      font-family: inherit;
      letter-spacing: 2px;
      cursor: pointer;
      box-shadow: 0 6px 20px rgba(201,103,58,0.30);
      transition: background 0.2s, transform 0.15s, box-shadow 0.2s, opacity 0.2s;
      margin-top: 4px;
    }
    .btn-analyze:disabled {
      background: #D4C4B8;
      box-shadow: none;
      cursor: not-allowed;
      opacity: 0.65;
    }
    .btn-analyze:not(:disabled):hover  { background: #B8592E; box-shadow: 0 8px 24px rgba(201,103,58,0.38); }
    .btn-analyze:not(:disabled):active { transform: scale(0.97); box-shadow: 0 3px 12px rgba(201,103,58,0.22); }
    .upload-note {
      text-align: center;
      font-size: 11px;
      color: #C8B8B0;
      letter-spacing: 0.5px;
      line-height: 1.8;
    }

    /* ========== OCRè§£æçµæœ ========== */
    .ocr-result-box {
      background: #FFFAF7;
      border: 1.5px solid #E8D8CC;
      border-radius: 20px;
      padding: 20px;
    }
    .ocr-result-title {
      font-size: 12px;
      font-weight: 700;
      color: #C9673A;
      margin-bottom: 12px;
      letter-spacing: 2px;
      text-transform: uppercase;
    }
    .ocr-text-area {
      font-size: 12px;
      color: #6A5848;
      line-height: 1.9;
      white-space: pre-wrap;
      word-break: break-all;
      max-height: 200px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
    }
    .ocr-parsed-list {
      margin-top: 14px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .ocr-parsed-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #FFF5EE;
      border-radius: 12px;
      padding: 8px 14px;
      font-size: 13px;
      font-weight: 500;
      color: #7A5C48;
    }
    .ocr-parsed-item span:last-child {
      font-weight: 700;
      color: #C9673A;
    }
    .ocr-empty {
      text-align: center;
      color: #C8B8B0;
      font-size: 12px;
      padding: 12px 0;
      letter-spacing: 0.5px;
    }
  </style>
</head>
<body>

<!-- ========== ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ ========== -->
<div id="screen-start">
  <div class="start-illustration">ğŸ§¾</div>
  <div class="start-logo">ã‚ã‘ã£ã“</div>
  <div class="start-tagline">ãƒ¬ã‚·ãƒ¼ãƒˆã‚’èª­ã¿è¾¼ã‚“ã§<br>ã‹ã‚“ãŸã‚“å‰²ã‚Šå‹˜</div>
  <button class="btn-start" id="btnGoUpload">ãƒ¬ã‚·ãƒ¼ãƒˆã‚’èª­ã¿è¾¼ã‚€</button>
  <input type="file" id="startCameraInput" accept="image/*" capture="environment" style="display:none">
  <div class="start-footer">ã¾ãšã¯ãƒ¬ã‚·ãƒ¼ãƒˆã®å†™çœŸã‚’ç”¨æ„ã—ã¦ã­</div>
</div>

<!-- ========== ãƒ¬ã‚·ãƒ¼ãƒˆèª­ã¿è¾¼ã¿ç”»é¢ ========== -->
<div id="screen-upload">
  <div class="upload-header">
    <button class="btn-back" id="btnBack">â† ã‚‚ã©ã‚‹</button>
    <div class="upload-page-title">ãƒ¬ã‚·ãƒ¼ãƒˆã‚’èª­ã¿è¾¼ã‚€</div>
  </div>

  <div class="upload-body">
    <!-- ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¾ãƒ¼ãƒ³ï¼ˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªç”¨ï¼‰ -->
    <label class="upload-zone" id="uploadZone" for="fileInput">
      <div class="upload-zone-placeholder">
        <div class="upload-zone-icon">ğŸ§¾</div>
        <div class="upload-zone-label">ã‚¿ãƒƒãƒ—ã—ã¦ç”»åƒã‚’é¸æŠ</div>
        <div class="upload-zone-sub">JPG Â· PNG Â· HEIC ã«å¯¾å¿œ</div>
      </div>
      <img class="preview-img" id="previewImg" alt="ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼">
      <div class="preview-badge">âœ“ é¸æŠæ¸ˆã¿</div>
    </label>
    <input type="file" id="fileInput" accept="image/*" style="display:none">
    <!-- ã‚«ãƒ¡ãƒ©å°‚ç”¨ inputï¼ˆcaptureï¼‰ -->
    <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display:none">

    <!-- ã‚µãƒ–ãƒœã‚¿ãƒ³è¡Œ -->
    <div class="upload-btn-row">
      <button class="btn-upload-opt" id="btnLibrary">
        <span class="btn-upload-opt-icon">ğŸ–¼ï¸</span>
        <span>ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‹ã‚‰</span>
      </button>
      <button class="btn-upload-opt" id="btnCamera">
        <span class="btn-upload-opt-icon">ğŸ“·</span>
        <span>å†™çœŸã‚’æ’®ã‚‹</span>
      </button>
    </div>

    <!-- è§£æãƒœã‚¿ãƒ³ -->
    <button class="btn-analyze" id="btnAnalyze" disabled>è§£æã™ã‚‹</button>
    <p class="upload-note">ãƒ¬ã‚·ãƒ¼ãƒˆå…¨ä½“ãŒæ˜ ã‚‹ã‚ˆã†ã«æ’®å½±ã—ã¦ãã ã•ã„</p>

    <!-- OCRè§£æçµæœã‚¨ãƒªã‚¢ -->
    <div id="ocrResult" style="display:none">
      <div class="ocr-result-box">
        <div class="ocr-result-title">è§£æçµæœ</div>
        <div id="ocrText" class="ocr-text-area"></div>
        <div id="ocrParsedList" class="ocr-parsed-list"></div>
      </div>
      <button class="btn-analyze" id="btnGoMain" style="display:none;margin-top:4px">å‰²ã‚Šå‹˜ãƒªã‚¹ãƒˆã«è¿½åŠ ã—ã¦é€²ã‚€ â†’</button>
    </div>
  </div>
</div>

<!-- ========== ãƒ¡ã‚¤ãƒ³ç”»é¢ ========== -->
<div id="screen-main">
<div class="header">
  <div class="logo">ã‚ã‘ã£ã“</div>
  <div class="logo-sub">ã¿ã‚“ãªã§ã‹ã‚“ãŸã‚“å‰²ã‚Šå‹˜</div>
</div>

<div class="layout">
  <!-- ===== å·¦ã‚«ãƒ©ãƒ : å…¥åŠ› ===== -->
  <div class="col-left">
    <div class="card">
      <div class="card-title">å•†å“ã‚’è¿½åŠ </div>
      <div class="form-grid">
        <input type="text" id="itemName" placeholder="å•†å“åï¼ˆä¾‹: ãƒ”ã‚¶ï¼‰">
        <input type="number" id="itemPrice" placeholder="Â¥ é‡‘é¡" min="0">
      </div>
      <button class="btn-add" id="btnAdd">+ è¿½åŠ ã™ã‚‹</button>
    </div>

    <div id="itemList">
      <div class="empty-msg">å•†å“ã‚’è¿½åŠ ã™ã‚‹ã¨ã€ã“ã“ã«ä¸€è¦§ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div>
    </div>

    <button class="btn-clear" id="btnClear">ã™ã¹ã¦ã‚¯ãƒªã‚¢</button>
  </div>

  <!-- ===== å³ã‚«ãƒ©ãƒ : çµæœ ===== -->
  <div class="col-right">
    <div class="card" id="resultCard">
      <div class="card-title">è¨ˆç®—çµæœ</div>
      <div id="resultContent">
        <div class="result-empty">å•†å“ã‚’è¿½åŠ ã™ã‚‹ã¨ã“ã“ã«çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div>
      </div>
    </div>
  </div>
</div>

<script>
  /* ================================================================
     ã‚ã‘ã£ã“ â€” ãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯
     ================================================================ */

  // â”€â”€ å®šæ•°ãƒ»çŠ¶æ…‹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const MEMBERS = [
    { key: 'me', label: 'è‡ªåˆ†',  cl: 'cl-me', box: 'me', hcl: 'h-me', fcl: 'f-me' },
    { key: 'a',  label: 'Aã•ã‚“', cl: 'cl-a',  box: 'a',  hcl: 'h-a',  fcl: 'f-a'  },
    { key: 'b',  label: 'Bã•ã‚“', cl: 'cl-b',  box: 'b',  hcl: 'h-b',  fcl: 'f-b'  },
    { key: 'c',  label: 'Cã•ã‚“', cl: 'cl-c',  box: 'c',  hcl: 'h-c',  fcl: 'f-c'  },
  ];

  const items = [];
  const $ = id => document.getElementById(id);
  let selectedFile = null;

  // â”€â”€ ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function esc(s) {
    const d = document.createElement('div');
    d.textContent = s;
    return d.innerHTML;
  }

  function zenToHan(str) {
    return str
      .replace(/[ï¼-ï¼™]/g, c => String.fromCharCode(c.charCodeAt(0) - 0xFEE0))
      .replace(/[^0-9]/g, '');
  }

  // â”€â”€ ç”»é¢åˆ‡æ›¿ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function showScreen(id) {
    ['screen-start', 'screen-upload', 'screen-main'].forEach(s => {
      const el = $(s);
      if (el) el.style.display = 'none';
    });
    const target = $(id);
    if (target) target.style.display = id === 'screen-upload' ? 'flex' : 'block';
  }

  // â”€â”€ OCR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  /**
   * ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å—ã‘å–ã‚Šã€ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºã¨ OCR ã‚’åŒæ™‚ã«é–‹å§‹ã™ã‚‹ã€‚
   * fileInput / cameraInput / startCameraInput ã™ã¹ã¦ã‹ã‚‰ã“ã“ã‚’å‘¼ã¶ã€‚
   */
  function handleFile(file) {
    if (!file || !file.type.startsWith('image/')) return;
    selectedFile = file;

    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
    const reader = new FileReader();
    reader.onload = e => {
      $('previewImg').src = e.target.result;
      $('uploadZone').classList.add('has-image');
    };
    reader.readAsDataURL(file);

    // OCR è‡ªå‹•é–‹å§‹
    analyzeReceipt(file);
  }

  /**
   * Tesseract.jsï¼ˆæ—¥æœ¬èªï¼‰ã§ OCR ã‚’å®Ÿè¡Œã—ã€çµæœã‚’ç”»é¢ã«è¡¨ç¤ºã™ã‚‹ã€‚
   */
  async function analyzeReceipt(file) {
    const btnAnalyze = $('btnAnalyze');
    const ocrResult  = $('ocrResult');
    const ocrText    = $('ocrText');
    const ocrParsed  = $('ocrParsedList');
    const btnGoMain  = $('btnGoMain');

    // è§£æä¸­ UI ã«ãƒªã‚»ãƒƒãƒˆ
    btnAnalyze.disabled     = true;
    btnAnalyze.textContent  = 'è§£æä¸­â€¦';
    ocrResult.style.display = 'block';
    ocrText.textContent     = 'è§£æã—ã¦ã„ã¾ã™â€¦';
    ocrParsed.innerHTML     = '';
    btnGoMain.style.display = 'none';

    try {
      const { data: { text } } = await Tesseract.recognize(file, 'jpn', {
        logger: ({ status, progress }) => {
          if (status === 'recognizing text') {
            const pct = Math.round(progress * 100);
            btnAnalyze.textContent = `è§£æä¸­â€¦ ${pct}%`;
            ocrText.textContent    = `è§£æã—ã¦ã„ã¾ã™â€¦ ${pct}%`;
          }
        },
      });

      // ç”Ÿãƒ†ã‚­ã‚¹ãƒˆè¡¨ç¤º
      ocrText.textContent = text.trim() || 'ï¼ˆãƒ†ã‚­ã‚¹ãƒˆã‚’æ¤œå‡ºã§ãã¾ã›ã‚“ã§ã—ãŸï¼‰';

      // å•†å“ãƒ»é‡‘é¡ã®ãƒ‘ãƒ¼ã‚¹
      const parsed = parseReceiptItems(text);

      if (parsed.length > 0) {
        ocrParsed.innerHTML = parsed
          .map(it =>
            `<div class="ocr-parsed-item">`
            + `<span>${esc(it.name)}</span>`
            + `<span>Â¥${it.price.toLocaleString()}</span>`
            + `</div>`
          )
          .join('');
        btnGoMain.textContent   = 'å‰²ã‚Šå‹˜ãƒªã‚¹ãƒˆã«è¿½åŠ ã—ã¦é€²ã‚€ â†’';
        btnGoMain.style.display = 'block';
        btnGoMain.onclick = () => {
          parsed.forEach(it => {
            const checked = {};
            MEMBERS.forEach(m => (checked[m.key] = false));
            items.push({ id: Date.now() + (Math.random() * 1000 | 0), name: it.name, price: it.price, checked });
          });
          render();
          showScreen('screen-main');
        };
      } else {
        ocrParsed.innerHTML     = '<div class="ocr-empty">å•†å“ã¨é‡‘é¡ã‚’è‡ªå‹•æ¤œå‡ºã§ãã¾ã›ã‚“ã§ã—ãŸã€‚æ‰‹å‹•ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</div>';
        btnGoMain.textContent   = 'æ‰‹å‹•ã§å…¥åŠ›ã™ã‚‹ â†’';
        btnGoMain.style.display = 'block';
        btnGoMain.onclick       = () => showScreen('screen-main');
      }
    } catch {
      ocrText.textContent = 'OCRã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
    } finally {
      btnAnalyze.disabled    = false;
      btnAnalyze.textContent = 'å†è§£æã™ã‚‹';
    }
  }

  /**
   * OCR ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰ã€Œå•†å“å + é‡‘é¡ã€ã®è¡Œã‚’æŠ½å‡ºã™ã‚‹ã€‚
   * å¯¾å¿œãƒ‘ã‚¿ãƒ¼ãƒ³ä¾‹: "ãƒ“ãƒ¼ãƒ« 500" / "ãƒ”ã‚¶ Â¥1,200" / "é‹ 2000å††"
   */
  function parseReceiptItems(text) {
    const seen    = new Set();
    const results = [];

    for (const raw of text.split('\n')) {
      const line = raw.trim();
      if (!line) continue;

      const m = line.match(/^(.+?)\s+[Â¥ï¿¥]?\s*([0-9ï¼-ï¼™][0-9ï¼-ï¼™,ï¼Œ]*)\s*å††?\s*$/);
      if (!m) continue;

      const name = m[1].replace(/[*ï¼Šâ€»â—‹â—â—†â–¶]+/g, '').trim();
      const price = parseInt(
        m[2]
          .replace(/[,ï¼Œ]/g, '')
          .replace(/[ï¼-ï¼™]/g, c => String.fromCharCode(c.charCodeAt(0) - 0xFEE0)),
        10
      );

      if (!name || isNaN(price) || price <= 0 || price >= 1_000_000) continue;

      const key = `${name}:${price}`;
      if (seen.has(key)) continue;
      seen.add(key);
      results.push({ name, price });
    }

    return results;
  }

  // â”€â”€ å•†å“ãƒªã‚¹ãƒˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function addItem() {
    const name  = $('itemName').value.trim();
    const price = parseInt($('itemPrice').value, 10);
    if (!name)                     { $('itemName').focus();  return; }
    if (isNaN(price) || price < 0) { $('itemPrice').focus(); return; }

    const checked = {};
    MEMBERS.forEach(m => (checked[m.key] = false));
    items.push({ id: Date.now(), name, price, checked });

    $('itemName').value  = '';
    $('itemPrice').value = '';
    $('itemName').focus();
    render();
  }

  function deleteItem(id) {
    const i = items.findIndex(x => x.id === id);
    if (i !== -1) { items.splice(i, 1); render(); }
  }

  function toggle(itemId, key) {
    const item = items.find(x => x.id === itemId);
    if (item) { item.checked[key] = !item.checked[key]; render(); }
  }

  function calcShares(item) {
    const shares = {};
    MEMBERS.forEach(m => (shares[m.key] = 0));
    const sel = MEMBERS.filter(m => item.checked[m.key]);
    if (sel.length === 0) { shares.me = item.price; return shares; }
    const base = Math.floor(item.price / sel.length);
    const rem  = item.price % sel.length;
    sel.forEach((m, i) => { shares[m.key] = base + (i < rem ? 1 : 0); });
    return shares;
  }

  function hint(item) {
    const sel = MEMBERS.filter(m => item.checked[m.key]);
    if (sel.length === 0) return '<b>è‡ªåˆ†ã«å…¨é¡åŠ ç®—</b>';
    return `${sel.map(m => m.label).join(' + ')} ã§ <b>${sel.length}äººå‰²ã‚Š</b>`;
  }

  function render() {
    if (items.length === 0) {
      $('itemList').innerHTML      = '<div class="empty-msg">å•†å“ã‚’è¿½åŠ ã™ã‚‹ã¨ã€ã“ã“ã«ä¸€è¦§ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div>';
      $('resultContent').innerHTML = '<div class="result-empty">å•†å“ã‚’è¿½åŠ ã™ã‚‹ã¨ã“ã“ã«çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div>';
      return;
    }

    $('itemList').innerHTML = items.map(item => {
      const pills = MEMBERS.map(m => {
        const uid = `c_${item.id}_${m.key}`;
        const chk = item.checked[m.key] ? 'checked' : '';
        return `<span class="pill">`
          + `<input type="checkbox" id="${uid}" ${chk} onchange="toggle(${item.id},'${m.key}')">`
          + `<label for="${uid}" class="${m.cl}">${esc(m.label)}</label>`
          + `</span>`;
      }).join('');

      return `<div class="item-card">`
        + `<div class="item-top">`
        +   `<div>`
        +     `<div class="item-name">${esc(item.name)}</div>`
        +     `<span class="item-price-badge">Â¥${item.price.toLocaleString()}</span>`
        +   `</div>`
        +   `<button class="btn-del" onclick="deleteItem(${item.id})" title="å‰Šé™¤">&times;</button>`
        + `</div>`
        + `<div class="checks">${pills}</div>`
        + `<div class="split-note">${hint(item)}</div>`
        + `</div>`;
    }).join('');

    const totals = {};
    MEMBERS.forEach(m => (totals[m.key] = 0));

    const rows = items.map(item => {
      const sh = calcShares(item);
      MEMBERS.forEach(m => (totals[m.key] += sh[m.key]));
      const cells = MEMBERS.map(m => {
        const v = sh[m.key];
        return `<td class="${v > 0 ? 'val' : 'zero'}">${v > 0 ? 'Â¥' + v.toLocaleString() : '-'}</td>`;
      }).join('');
      return `<tr onclick="this.classList.toggle('expanded')">`
        + `<td><span class="cell-name">${esc(item.name)}</span></td>${cells}`
        + `</tr>`;
    }).join('');

    const boxes = MEMBERS.map(m =>
      `<div class="total-box ${m.box}">`
      + `<div class="total-name">${esc(m.label)}</div>`
      + `<div class="total-yen">Â¥${totals[m.key].toLocaleString()}</div>`
      + `</div>`
    ).join('');

    const ths = MEMBERS.map(m => `<th class="${m.hcl}">${esc(m.label)}</th>`).join('');
    const fts = MEMBERS.map(m => `<td class="${m.fcl}">Â¥${totals[m.key].toLocaleString()}</td>`).join('');

    $('resultContent').innerHTML =
      `<div class="totals-grid">${boxes}</div>`
      + `<table class="detail-table">`
      +   `<thead><tr><th>å•†å“</th>${ths}</tr></thead>`
      +   `<tbody>${rows}</tbody>`
      +   `<tfoot><tr><td>åˆè¨ˆ</td>${fts}</tr></tfoot>`
      + `</table>`;
  }

  // â”€â”€ ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  // å…¨è§’æ•°å­—ã®åŠè§’å¤‰æ›
  $('itemPrice').addEventListener('compositionend', function () {
    const converted = zenToHan(this.value);
    if (converted) this.value = converted;
  });

  // å•†å“è¿½åŠ 
  $('btnAdd').addEventListener('click', addItem);
  $('itemPrice').addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); addItem(); } });
  $('itemName').addEventListener('keydown',  e => { if (e.key === 'Enter') { e.preventDefault(); $('itemPrice').focus(); } });

  // ã‚¯ãƒªã‚¢
  $('btnClear').addEventListener('click', () => {
    if (items.length === 0) return;
    if (confirm('ã™ã¹ã¦ã®å•†å“ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')) { items.length = 0; render(); }
  });

  // ç”»é¢é·ç§»
  $('btnBack').addEventListener('click', () => showScreen('screen-start'));

  // ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ â†’ ã‚«ãƒ¡ãƒ©èµ·å‹•
  $('btnGoUpload').addEventListener('click', () => $('startCameraInput').click());

  // ã‚«ãƒ¡ãƒ©æ’®å½±å¾Œ â†’ screen-upload ã‚’è¡¨ç¤ºã—ã¦ OCR è‡ªå‹•é–‹å§‹
  $('startCameraInput').addEventListener('change', e => {
    const file = e.target.files[0];
    if (file) { showScreen('screen-upload'); handleFile(file); }
  });

  // ãƒ©ã‚¤ãƒ–ãƒ©ãƒª / ã‚«ãƒ¡ãƒ© ãƒœã‚¿ãƒ³
  $('btnLibrary').addEventListener('click', () => $('fileInput').click());
  $('btnCamera').addEventListener('click',  () => $('cameraInput').click());

  // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ â†’ OCR è‡ªå‹•é–‹å§‹
  $('fileInput').addEventListener('change',   e => { if (e.target.files[0]) handleFile(e.target.files[0]); });
  $('cameraInput').addEventListener('change', e => { if (e.target.files[0]) handleFile(e.target.files[0]); });

  // å†è§£æãƒœã‚¿ãƒ³ï¼ˆOCR å®Œäº†å¾Œã«ã€Œå†è§£æã™ã‚‹ã€ã¨ã—ã¦æ©Ÿèƒ½ï¼‰
  $('btnAnalyze').addEventListener('click', () => {
    if (selectedFile) analyzeReceipt(selectedFile);
  });
</script>

</div><!-- /screen-main -->
<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('service-worker.js')
    .then(() => console.log('Service Worker Registered'));
  }
</script>
</body>
</html>
